<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الاختبار السيكومتري</title>
    <!-- Load Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        /* Custom styles for print media */
        @media print {
            .no-print {
                display: none !important;
            }
            body {
                background-color: #fff !important;
                margin: 0;
                padding: 0;
                -webkit-print-color-adjust: exact; /* Ensures background colors are printed */
                print-color-adjust: exact;
            }
            .print\:shadow-none {
                box-shadow: none !important;
            }
            .print\:border-none {
                border: none !important;
            }
            .print\:rounded-none {
                border-radius: 0 !important;
            }
            .print\:text-3xl {
                font-size: 1.875rem !important; /* 30px */
            }
            .print\:mb-4 {
                margin-bottom: 1rem !important; /* 16px */
            }
            .print\:text-xl {
                font-size: 1.25rem !important; /* 20px */
            }
            .print\:border-b {
                border-bottom-width: 1px !important;
            }
            .print\:pb-1 {
                padding-bottom: 0.25rem !important; /* 4px */
            }
            .print\:text-base {
                font-size: 1rem !important; /* 16px */
            }
            .print\:text-sm {
                font-size: 0.875rem !important; /* 14px */
            }
            .print\:p-0 {
                padding: 0 !important;
            }
            .print\:mb-4 {
                margin-bottom: 1rem !important;
            }
            .print\:bg-white {
                background-color: #fff !important;
            }
            .print\:p-2 {
                padding: 0.5rem !important;
            }
            .print\:p-3 {
                padding: 0.75rem !important;
            }
            .print\:block {
                display: block !important;
            }

            /* New print adjustments for better page breaks and layout */
            .print-container {
                width: 100%;
                margin: 0 auto;
                padding: 1cm; /* Add some padding for print margins */
            }

            /* Ensure sections don't break across pages */
            .print-avoid-break {
                page-break-inside: avoid;
            }

            /* Adjust font sizes for print to be slightly smaller for density */
            .print-report-text {
                font-size: 0.9rem !important; /* Slightly smaller for report body text */
            }
            .print-report-heading {
                font-size: 1.5rem !important; /* Slightly smaller for section headings */
            }
            .print-report-subheading {
                font-size: 1.1rem !important; /* Slightly smaller for subheadings */
            }

            /* Adjust spacing for print */
            .print-space-y-4 > *:not(:last-child) {
                margin-bottom: 1rem !important;
            }
            .print-mb-3 {
                margin-bottom: 0.75rem !important;
            }
            /* Chart specific print styles */
            .print-chart-container {
                width: 100% !important;
                height: auto !important;
                page-break-inside: avoid;
                margin-bottom: 1rem !important;
            }
            .print-chart-canvas {
                width: 100% !important;
                height: 300px !important; /* Fixed height for print */
            }
        }
    </style>
</head>
<body>
    <div id="app-root">
        <!-- Content will be rendered here by JavaScript -->
    </div>

    <script>
        // Global state variables
        let currentView = 'intro';
        let studentInfo = {
            name: '',
            date: '',
            traineeCode: '', // New field
            age: '',         // New field
            nationality: '', // New field
            phone: '',       // New field
            currentJob: '',  // New field
            educationalLevel: '' // New field
        };
        let answers = {};
        let results = null;

        // Reference to the main application root element
        const appRoot = document.getElementById('app-root');

        // Define the questions and their categories
        const questionsData = {
            'الانفتاح على التجربة': [
                'أستمتع بتعلم أشياء جديدة واستكشاف أفكار مختلفة.',
                'أبحث دائماً عن طرق مبتكرة لحل المشكلات.',
                'أحب تجربة الأنشطة الجديدة وغير المألوفة.',
                'أجد متعة في التفكير في المفاهيم المجردة والفلسفية.',
                'أقدر الفن والموسيقى والأدب وأستمتع بها.',
                'أتقبل التغيير بسهولة وأتكيف مع الظروف الجديدة.',
            ],
            'الضمير الحي': [
                'أخطط لمهامي بعناية وألتزم بالجداول الزمنية.',
                'أنا شخص منظم ودقيق في عملي.',
                'أشعر بالمسؤولية تجاه المهام الموكلة إليّ وأحرص على إنجازها بأفضل شكل.',
                'أولي اهتماماً كبيراً للتفاصيل وأسعى للكمال.',
                'أعمل بجد ومثابرة لتحقيق أهدافي.',
                'ألتزم بالوعود التي أقطعها وأكون موثوقاً به.',
            ],
            'الانبساط': [
                'أستمتع بالتفاعل مع الآخرين وأكون مبادراً في المحادثات.',
                'أشعر بالراحة عند التحدث أمام مجموعة كبيرة من الناس.',
                'أحب أن أكون مركز الاهتمام في التجمعات الاجتماعية.',
                'أمتلك طاقة عالية وأكون نشيطاً في معظم الأوقات.',
                'أكون ودوداً ومنفتحاً عند التعرف على أشخاص جدد.',
                'أستمتع بالمشاركة في الأنشطة الجماعية والفعاليات الاجتماعية.',
            ],
            'الوفاقية': [
                'أتعاون مع الآخرين بسهولة وأفضل العمل الجماعي.',
                'أتعاطف مع مشاعر الآخرين وأحاول فهم وجهات نظرهم.',
                'أكون مستعداً لتقديم المساعدة للآخرين عند الحاجة.',
                'أتعامل بلطف واحترام مع جميع الناس.',
                'أحرص على تجنب الخلافات وأسعى لحل النزاعات بشكل ودي.',
                'أثق بالآخرين وأفترض حسن النوايا لديهم.',
            ],
            'الاستقرار العاطفي / العصابية': [
                'أتعامل مع الضغوط بهدوء وأحافظ على رباطة جأشي.',
                'نادراً ما أشعر بالقلق أو التوتر بشأن المستقبل.',
                'أتعافى بسرعة من الإحباطات والتحديات.',
                'أرى الجانب الإيجابي في معظم المواقف، حتى الصعبة منها.',
                'أتحكم في انفعالاتي ولا أدعها تؤثر على قراراتي.',
                'أمتلك ثقة عالية بنفسي وقدراتي.',
            ],
        };

        // Helper function to get detailed analysis text
        function getAnalysisText(category, interpretation, score) {
            let text = '';
            let strengths = '';
            let development = '';
            let interaction = '';
            let futureCareers = '';

            switch (category) {
                case 'الانفتاح على التجربة':
                    if (interpretation === 'مرتفع') {
                        text = 'تتميز بفضولك، إبداعك، وحبك للمغامرة. تفكيرك غير تقليدي وتقدر الفن والجمال، وتميل للتجديد.';
                        strengths = 'القدرة على توليد أفكار جديدة، تقبل التغيير، حل المشكلات بطرق مبتكرة.';
                        development = 'قد تحتاج إلى التركيز على إنجاز المهام بدلاً من التنقل بين الأفكار.';
                        interaction = 'تتفاعل بشكل جيد مع الأشخاص الذين يقدرون الإبداع والأفكار الجديدة. قد تجد صعوبة مع الروتينيين.';
                        futureCareers = 'الإبداع، الابتكار، البحث العلمي، الفنون، التصميم، ريادة الأعمال.';
                    } else if (interpretation === 'متوسط') {
                        text = 'لديك استعداد لتعلم أشياء جديدة وتقبل بعض الأفكار المختلفة، ولكنك قد تفضل بعض الاستقرار.';
                        strengths = 'مرونة معتدلة، القدرة على التكيف مع التحديات الجديدة بشكل متوازن.';
                        development = 'يمكنك استكشاف المزيد من الأنشطة الجديدة لتوسيع آفاقك.';
                        interaction = 'تتفاعل بشكل مقبول مع معظم الأشخاص، وقد تكون جسراً بين المبدعين والتقليديين.';
                        futureCareers = 'مجالات تتطلب التفكير التحليلي والتكيف مثل إدارة المشاريع، التعليم، الاستشارات.';
                    } else { // منخفض
                        text = 'تميل إلى التفكير العملي والتقليدي، وتفضل الروتين والاستقرار على التجديد والمغامرة.';
                        strengths = 'التركيز على التفاصيل، الالتزام بالخطط، الكفاءة في المهام الروتينية.';
                        development = 'حاول أن تكون أكثر انفتاحاً على الأفكار الجديدة والتغيير.';
                        interaction = 'قد تفضل التفاعل مع الأشخاص الذين يشاركونك نفس الاهتمامات والأساليب.';
                        futureCareers = 'المهن التي تتطلب الدقة والالتزام بالمعايير مثل المحاسبة، الإدارة، الأدوار التنفيذية.';
                    }
                    break;
                case 'الضمير الحي':
                    if (interpretation === 'مرتفع') {
                        text = 'أنت شخص منظم، منضبط، ومسؤول. تولي اهتماماً كبيراً للتفاصيل وتسعى للكمال في عملك.';
                        strengths = 'القدرة على التخطيط الجيد، الالتزام بالمواعيد، تحقيق الأهداف بكفاءة، الموثوقية.';
                        development = 'قد تحتاج إلى المرونة في بعض الأحيان وتجنب الإفراط في الكمالية.';
                        interaction = 'تتفاعل بفاعلية في بيئات العمل المنظمة وتفضل الزملاء الملتزمين.';
                        futureCareers = 'الإدارة، التخطيط الاستراتيجي، الهندسة، المحاسبة، إدارة المشاريع، الأدوار التنفيذية.';
                    } else if (interpretation === 'متوسط') {
                        text = 'لديك مستوى جيد من التنظيم والمسؤولية، ولكن قد تحتاج إلى بعض التحسين في الالتزام بالتفاصيل أو الجداول الزمنية.';
                        strengths = 'متوازن بين التنظيم والمرونة، القدرة على إنجاز المهام بشكل جيد.';
                        development = 'يمكنك العمل على تحسين مهاراتك في التخطيط وإدارة الوقت.';
                        interaction = 'تتفاعل بشكل جيد في بيئات العمل المختلفة وتستطيع التكيف مع مستويات مختلفة من التنظيم.';
                        futureCareers = 'مجالات تتطلب مزيجاً من التنظيم والإبداع مثل التسويق، العلاقات العامة، التدريب.';
                    } else { // منخفض
                        text = 'أنت أكثر عفوية وتلقائية، وقد تجد صعوبة في الالتزام بالجداول الزمنية أو التركيز على التفاصيل.';
                        strengths = 'المرونة، القدرة على التكيف السريع، التفكير خارج الصندوق.';
                        development = 'اعمل على تطوير مهاراتك في التنظيم والتخطيط لتحقيق أهدافك بفاعلية أكبر.';
                        interaction = 'قد تفضل بيئات العمل المرنة وتجد صعوبة في التعامل مع القواعد الصارمة.';
                        futureCareers = 'المهن التي تتطلب العفوية والمرونة مثل الفنون، المبيعات، الأدوار الإبداعية.';
                    }
                    break;
                case 'الانبساط':
                    if (interpretation === 'مرتفع') {
                        text = 'أنت شخص اجتماعي، حيوي، وواثق من نفسك. تستمتع بالتفاعل مع الآخرين وتميل للقيادة.';
                        strengths = 'مهارات تواصل ممتازة، القدرة على التأثير في الآخرين، بناء علاقات قوية، طاقة عالية.';
                        development = 'قد تحتاج إلى تخصيص وقت للتفكير الهادئ وتجنب الإفراط في التفاعل الاجتماعي.';
                        interaction = 'تتألق في التجمعات الاجتماعية وتكون مبادراً في المحادثات. تجذب الآخرين إليك بسهولة.';
                        futureCareers = 'المبيعات، التسويق، العلاقات العامة، التدريب، القيادة، خدمة العملاء.';
                    } else if (interpretation === 'متوسط') {
                        text = 'أنت متوازن بين الانفتاح على الآخرين والاستمتاع بالوقت الخاص. تستطيع التفاعل بفاعلية عند الحاجة.';
                        strengths = 'القدرة على التكيف مع المواقف الاجتماعية المختلفة، مهارات تواصل جيدة.';
                        development = 'يمكنك العمل على تعزيز ثقتك بنفسك في المواقف الاجتماعية الكبيرة.';
                        interaction = 'تتفاعل بشكل مريح في معظم المواقف الاجتماعية وتستطيع بناء علاقات جيدة.';
                        futureCareers = 'مجالات تتطلب توازناً بين العمل الفردي والجماعي مثل إدارة المشاريع، التعليم، الموارد البشرية.';
                    } else { // منخفض
                        text = 'أنت شخص هادئ ومتحفظ، تفضل التفاعلات العميقة مع عدد قليل من الأشخاص على التجمعات الكبيرة.';
                        strengths = 'الاستماع الجيد، التفكير العميق، القدرة على التركيز، الاستقلالية.';
                        development = 'حاول أن تكون أكثر انفتاحاً في التفاعلات الاجتماعية لتوسيع دائرة معارفك.';
                        interaction = 'قد تفضل التفاعل مع الأشخاص الذين يقدرون الهدوء والعمق في المحادثات.';
                        futureCareers = 'البحث العلمي، الكتابة، البرمجة، التحليل، أي مهنة تتطلب التركيز والعمل الفردي.';
                    }
                    break;
                case 'الوفاقية':
                    if (interpretation === 'مرتفع') {
                        text = 'أنت شخص متعاون، متعاطف، وودود. تثق بالآخرين وتسعى لمساعدتهم وتجنب الصراعات.';
                        strengths = 'مهارات عمل جماعي ممتازة، القدرة على حل النزاعات بشكل بناء، بناء علاقات إيجابية، التسامح.';
                        development = 'قد تحتاج إلى تعلم كيفية الدفاع عن آرائك ومصالحك عند الضرورة.';
                        interaction = 'تتفاعل بشكل إيجابي مع الجميع وتسعى لخلق بيئة متناغمة. أنت داعم للزملاء.';
                        futureCareers = 'خدمة العملاء، الاستشارات، الموارد البشرية، العمل الاجتماعي، التدريس، الوساطة.';
                    } else if (interpretation === 'متوسط') {
                        text = 'لديك استعداد للتعاون والتعاطف، ولكنك تستطيع أيضاً الدفاع عن نفسك عند الحاجة.';
                        strengths = 'متوازن بين التعاون والاستقلالية، القدرة على فهم وجهات نظر مختلفة.';
                        development = 'يمكنك العمل على تعزيز قدرتك على التفاوض وحل المشكلات.';
                        interaction = 'تتفاعل بشكل جيد في معظم المواقف وتستطيع بناء علاقات متوازنة.';
                        futureCareers = 'مجالات تتطلب مهارات تواصل وتعاون مثل إدارة المشاريع، التسويق، الصحافة.';
                    } else { // منخفض
                        text = 'أنت شخص أكثر واقعية ومباشرة، وقد لا تميل إلى التنازل بسهولة أو إظهار التعاطف بشكل علني.';
                        strengths = 'القدرة على اتخاذ قرارات صعبة، التركيز على الحقائق، الحزم.';
                        development = 'حاول أن تكون أكثر مرونة وتعاطفاً في تعاملاتك مع الآخرين.';
                        interaction = 'قد تفضل التفاعل مع الأشخاص الذين يقدرون الصراحة والمباشرة.';
                        futureCareers = 'المهن التي تتطلب الحزم واتخاذ القرارات الصعبة مثل القانون، الإدارة، التحقيقات.';
                    }
                    break;
                case 'الاستقرار العاطفي / العصابية': // Note: Low Neuroticism = High Emotional Stability
                    if (interpretation === 'مرتفع') { // High Emotional Stability (Low Neuroticism)
                        text = 'أنت شخص هادئ، واثق من نفسك، وقادر على التعامل مع الضغوط والتحديات بتفاؤل.';
                        strengths = 'التحكم في الانفعالات، المرونة النفسية، النظرة الإيجابية للمستقبل، القدرة على اتخاذ القرارات تحت الضغط.';
                        development = 'قد تحتاج إلى الاعتراف بمشاعرك والتعبير عنها بشكل صحي في بعض الأحيان.';
                        interaction = 'تتفاعل بهدوء وثبات، وتكون مصدراً للاطمئنان للآخرين في المواقف الصعبة.';
                        futureCareers = 'الأدوار القيادية، الطب، الطوارئ، الاستشارات، أي مهنة تتطلب الهدوء والاتزان تحت الضغط.';
                    } else if (interpretation === 'متوسط') {
                        text = 'لديك مستوى جيد من الاستقرار العاطفي، ولكن قد تشعر ببعض التوتر أو القلق في المواقف الصعبة.';
                        strengths = 'القدرة على التعافي من الإحباطات، الوعي بمشاعرك، القدرة على التكيف.';
                        development = 'يمكنك العمل على تطوير آليات أفضل للتعامل مع التوتر والقلق.';
                        interaction = 'تتفاعل بشكل متوازن، وتستطيع التعبير عن مشاعرك بفاعلية.';
                        futureCareers = 'مجالات تتطلب توازناً بين التعامل مع الضغوط والعمل الهادئ مثل التعليم، الموارد البشرية، إدارة المشاريع.';
                    } else { // منخفض (High Neuroticism)
                        text = 'أنت أكثر عرضة للقلق والتوتر وتقلب المزاج، وقد تكون حساساً للنقد والتشاؤم.';
                        strengths = 'الوعي الذاتي، التعاطف مع الآخرين، القدرة على ملاحظة التفاصيل الدقيقة.';
                        development = 'اعمل على تطوير استراتيجيات للتحكم في التوتر والقلق، وركز على الجوانب الإيجابية.';
                        interaction = 'قد تحتاج إلى بيئة داعمة ومتفهمة لتتفاعل بفاعلية. قد تكون حساساً لآراء الآخرين.';
                        futureCareers = 'المهن التي تتطلب التعاطف والاهتمام بالتفاصيل مثل العلاج النفسي، الكتابة، الفنون.';
                    }
                    break;
                default:
                    break;
            }
            return { text, strengths, development, interaction, futureCareers };
        }

        // Function to draw the bar chart
        function drawChart(canvasId, data) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return; // Exit if canvas element is not found

            const ctx = canvas.getContext('2d');
            const parent = canvas.parentElement;

            // Set canvas dimensions based on parent for responsiveness
            // For print, we'll use fixed dimensions set by CSS
            if (window.matchMedia('print').matches) {
                canvas.width = parent.offsetWidth; // Use parent width in print
                canvas.height = 300; // Fixed height for print
            } else {
                canvas.width = parent.offsetWidth;
                canvas.height = Math.min(parent.offsetWidth * 0.6, 400); // Responsive height for screen
            }


            ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear canvas

            const margin = 50;
            const chartWidth = canvas.width - 2 * margin;
            const chartHeight = canvas.height - 2 * margin;
            const barWidth = chartWidth / data.length - 10; // Adjust bar width based on number of bars

            const maxScore = 30; // Max possible score for any category

            // Draw Y-axis (score labels)
            ctx.beginPath();
            ctx.moveTo(margin, margin);
            ctx.lineTo(margin, canvas.height - margin);
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.stroke();

            // Draw X-axis (category labels)
            ctx.beginPath();
            ctx.moveTo(margin, canvas.height - margin);
            ctx.lineTo(canvas.width - margin, canvas.height - margin);
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.stroke();

            ctx.font = '12px Inter';
            ctx.fillStyle = '#333';
            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';

            // Y-axis labels
            for (let i = 0; i <= maxScore; i += 5) {
                const y = canvas.height - margin - (i / maxScore) * chartHeight;
                ctx.fillText(i, margin - 10, y);
                ctx.beginPath();
                ctx.moveTo(margin, y);
                ctx.lineTo(margin + 5, y);
                ctx.strokeStyle = '#aaa';
                ctx.stroke();
            }

            // Draw bars
            data.forEach((item, index) => {
                const barHeight = (item.score / maxScore) * chartHeight;
                const x = margin + index * (chartWidth / data.length) + (chartWidth / data.length - barWidth) / 2;
                const y = canvas.height - margin - barHeight;

                // Bar color based on interpretation
                let barColor;
                if (item.interpretation === 'مرتفع') {
                    barColor = '#10B981'; // Green
                } else if (item.interpretation === 'متوسط') {
                    barColor = '#F59E0B'; // Yellow/Orange
                } else { // منخفض
                    barColor = '#EF4444'; // Red
                }

                ctx.fillStyle = barColor;
                ctx.fillRect(x, y, barWidth, barHeight);

                // Draw score text on top of the bar
                ctx.fillStyle = '#fff'; // White text for contrast
                ctx.textAlign = 'center';
                ctx.font = '14px Inter';
                ctx.fillText(item.score, x + barWidth / 2, y + 15); // Score inside bar

                // Draw category label below X-axis
                ctx.fillStyle = '#333';
                ctx.textAlign = 'center';
                ctx.font = '12px Inter';
                ctx.fillText(item.category, x + barWidth / 2, canvas.height - margin + 20);
            });
        }

        // Function to render the Intro Screen
        function renderIntroScreen() {
            appRoot.innerHTML = `
                <div class="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-blue-100 to-purple-100 p-4 font-inter">
                    <div class="bg-white p-8 rounded-3xl shadow-xl max-w-2xl w-full text-center border-4 border-blue-300 transform transition-all duration-300 hover:scale-105">
                        <h1 class="text-4xl font-extrabold text-blue-800 mb-6 drop-shadow-md">
                            دليل الاختبار السيكومتري
                        </h1>
                        <p class="text-lg text-gray-700 mb-8 leading-relaxed">
                            يهدف هذا الدليل إلى تقديم اختبار سيكومتري شامل وموثوق لتحديد نمط شخصية المتدربين في
                            دولة الإمارات العربية المتحدة. يرتكز الاختبار على نموذج السمات الخمس الكبرى (Big Five)،
                            ويهدف لمساعدتك على فهم ذاتك بشكل أعمق، وتحديد نقاط قوتك، وكيفية التفاعل بفعالية مع الآخرين،
                            بالإضافة إلى استكشاف المجالات التي يمكنك التميز فيها مستقبلاً.
                        </p>
                        <button id="start-test-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300">
                            ابدأ الاختبار
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('start-test-btn').addEventListener('click', () => {
                currentView = 'studentInfoModal';
                renderView();
            });
        }

        // Function to render the Student Info Modal
        function renderStudentInfoModal() {
            const educationalLevels = [
                'اختر المستوى التعليمي',
                'المرحلة الابتدائية',
                'المرحلة الإعدادية',
                'المرحلة الثانوية',
                'دبلوم',
                'بكالوريوس',
                'ماجستير',
                'دكتوراه',
                'أخرى'
            ];

            let educationalOptionsHtml = educationalLevels.map(level => `
                <option value="${level}" ${studentInfo.educationalLevel === level ? 'selected' : ''}>${level}</option>
            `).join('');

            appRoot.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 font-inter">
                    <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-2xl w-full text-center border-4 border-teal-400 animate-fade-in-up">
                        <h2 class="text-3xl font-extrabold text-teal-800 mb-6 drop-shadow-md">
                            معلومات المتدرب
                        </h2>
                        <form id="student-info-form" class="space-y-6 text-right">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="modal-name" class="block text-lg font-medium text-gray-700 mb-2">
                                        الاسم الكامل:
                                    </label>
                                    <input
                                        type="text"
                                        id="modal-name"
                                        name="name"
                                        value="${studentInfo.name}"
                                        required
                                        class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-xl shadow-sm focus:ring-teal-500 focus:border-teal-500 text-lg text-right"
                                        placeholder="أدخل اسمك الكامل"
                                    />
                                </div>
                                <div>
                                    <label for="modal-trainee-code" class="block text-lg font-medium text-gray-700 mb-2">
                                        رمز المتدرب (اختياري):
                                    </label>
                                    <input
                                        type="text"
                                        id="modal-trainee-code"
                                        name="traineeCode"
                                        value="${studentInfo.traineeCode}"
                                        class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-xl shadow-sm focus:ring-teal-500 focus:border-teal-500 text-lg text-right"
                                        placeholder="أدخل رمز المتدرب (اختياري)"
                                    />
                                </div>
                                <div>
                                    <label for="modal-age" class="block text-lg font-medium text-gray-700 mb-2">
                                        العمر:
                                    </label>
                                    <input
                                        type="number"
                                        id="modal-age"
                                        name="age"
                                        value="${studentInfo.age}"
                                        required
                                        min="10"
                                        max="100"
                                        class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-xl shadow-sm focus:ring-teal-500 focus:border-teal-500 text-lg text-right"
                                        placeholder="أدخل العمر"
                                    />
                                </div>
                                <div>
                                    <label for="modal-nationality" class="block text-lg font-medium text-gray-700 mb-2">
                                        الجنسية:
                                    </label>
                                    <input
                                        type="text"
                                        id="modal-nationality"
                                        name="nationality"
                                        value="${studentInfo.nationality}"
                                        required
                                        class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-xl shadow-sm focus:ring-teal-500 focus:border-teal-500 text-lg text-right"
                                        placeholder="أدخل الجنسية"
                                    />
                                </div>
                                <div>
                                    <label for="modal-phone" class="block text-lg font-medium text-gray-700 mb-2">
                                        رقم الهاتف:
                                    </label>
                                    <input
                                        type="tel"
                                        id="modal-phone"
                                        name="phone"
                                        value="${studentInfo.phone}"
                                        required
                                        class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-xl shadow-sm focus:ring-teal-500 focus:border-teal-500 text-lg text-right"
                                        placeholder="أدخل رقم الهاتف"
                                    />
                                </div>
                                <div>
                                    <label for="modal-current-job" class="block text-lg font-medium text-gray-700 mb-2">
                                        الوظيفة الحالية:
                                    </label>
                                    <input
                                        type="text"
                                        id="modal-current-job"
                                        name="currentJob"
                                        value="${studentInfo.currentJob}"
                                        required
                                        class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-xl shadow-sm focus:ring-teal-500 focus:border-teal-500 text-lg text-right"
                                        placeholder="أدخل الوظيفة الحالية"
                                    />
                                </div>
                                <div>
                                    <label for="modal-date" class="block text-lg font-medium text-gray-700 mb-2">
                                        تاريخ الاختبار (ميلادي):
                                    </label>
                                    <input
                                        type="date"
                                        id="modal-date"
                                        name="date"
                                        value="${studentInfo.date}"
                                        required
                                        class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-xl shadow-sm focus:ring-teal-500 focus:border-teal-500 text-lg text-right"
                                    />
                                </div>
                                <div>
                                    <label for="modal-educational-level" class="block text-lg font-medium text-gray-700 mb-2">
                                        المستوى التعليمي:
                                    </label>
                                    <select
                                        id="modal-educational-level"
                                        name="educationalLevel"
                                        required
                                        class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-xl shadow-sm focus:ring-teal-500 focus:border-teal-500 text-lg text-right bg-white"
                                    >
                                        ${educationalOptionsHtml}
                                    </select>
                                </div>
                            </div>
                            <button
                                type="submit"
                                class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-teal-300 text-lg"
                            >
                                بدء الامتحان
                            </button>
                        </form>
                    </div>
                </div>
            `;

            const studentInfoForm = document.getElementById('student-info-form');
            // Get references to all new input fields
            const modalNameInput = document.getElementById('modal-name');
            const modalTraineeCodeInput = document.getElementById('modal-trainee-code');
            const modalAgeInput = document.getElementById('modal-age');
            const modalNationalityInput = document.getElementById('modal-nationality');
            const modalPhoneInput = document.getElementById('modal-phone');
            const modalCurrentJobInput = document.getElementById('modal-current-job');
            const modalDateInput = document.getElementById('modal-date');
            const modalEducationalLevelSelect = document.getElementById('modal-educational-level');

            // Set initial values from studentInfo state
            modalNameInput.value = studentInfo.name;
            modalTraineeCodeInput.value = studentInfo.traineeCode;
            modalAgeInput.value = studentInfo.age;
            modalNationalityInput.value = studentInfo.nationality;
            modalPhoneInput.value = studentInfo.phone;
            modalCurrentJobInput.value = studentInfo.currentJob;
            modalDateInput.value = studentInfo.date;
            modalEducationalLevelSelect.value = studentInfo.educationalLevel;

            // Add event listeners for input changes to update studentInfo state
            modalNameInput.addEventListener('input', (e) => { studentInfo.name = e.target.value; });
            modalTraineeCodeInput.addEventListener('input', (e) => { studentInfo.traineeCode = e.target.value; });
            modalAgeInput.addEventListener('input', (e) => { studentInfo.age = e.target.value; });
            modalNationalityInput.addEventListener('input', (e) => { studentInfo.nationality = e.target.value; });
            modalPhoneInput.addEventListener('input', (e) => { studentInfo.phone = e.target.value; });
            modalCurrentJobInput.addEventListener('input', (e) => { studentInfo.currentJob = e.target.value; });
            modalDateInput.addEventListener('input', (e) => { studentInfo.date = e.target.value; });
            modalEducationalLevelSelect.addEventListener('change', (e) => { studentInfo.educationalLevel = e.target.value; });

            studentInfoForm.addEventListener('submit', (e) => {
                e.preventDefault();
                // Validate required fields
                if (studentInfo.name.trim() === '' || studentInfo.age.trim() === '' ||
                    studentInfo.nationality.trim() === '' || studentInfo.phone.trim() === '' ||
                    studentInfo.currentJob.trim() === '' || studentInfo.date.trim() === '' ||
                    studentInfo.educationalLevel === '' || studentInfo.educationalLevel === 'اختر المستوى التعليمي') {
                    alert('الرجاء إدخال جميع المعلومات المطلوبة للمتابعة.');
                    return;
                }
                currentView = 'form';
                renderView();
            });
        }

        // Function to render the Test Form
        function renderTestForm() {
            let questionIndexCounter = 0; // To keep track of global question index

            let questionsHtml = '';
            // Loop through each question category (though category titles are hidden)
            for (const category in questionsData) {
                // Loop through each question within the category
                questionsData[category].forEach((question, qIndex) => {
                    const currentQuestionIndex = questionIndexCounter++;
                    questionsHtml += `
                        <div class="bg-white p-6 rounded-2xl shadow-xl border border-teal-200 mb-6 print-avoid-break"> <!-- Each question is now a distinct box -->
                            <p class="text-lg font-medium text-gray-800 mb-4 text-right">
                                ${currentQuestionIndex + 1}. ${question}
                            </p>
                            <div class="flex flex-wrap justify-center gap-2"> <!-- Flexbox for answers, ensuring single line if space allows -->
                    `;
                    [1, 2, 3, 4, 5].forEach((value) => {
                        const isChecked = answers[currentQuestionIndex] === value ? 'checked' : '';
                        const labelClasses = answers[currentQuestionIndex] === value
                            ? 'bg-teal-500 text-white shadow-lg border-teal-600'
                            : 'bg-gray-100 text-gray-800 hover:bg-teal-100 hover:border-teal-300 border-gray-200';

                        questionsHtml += `
                                <label class="flex items-center cursor-pointer py-2 px-3 rounded-lg transition-all duration-200 ease-in-out border-2 ${labelClasses} flex-grow md:flex-grow-0">
                                    <input
                                        type="radio"
                                        name="question-${currentQuestionIndex}"
                                        value="${value}"
                                        data-question-index="${currentQuestionIndex}"
                                        ${isChecked}
                                        class="hidden"
                                        required
                                    />
                                    <div class="flex-shrink-0 w-7 h-7 flex items-center justify-center bg-teal-600 text-white rounded-full font-bold text-base ml-2 shadow-md">
                                        ${value}
                                    </div>
                                    <div class="flex-grow text-right text-sm whitespace-nowrap"> <!-- Added whitespace-nowrap -->
                                        ${value === 1 ? 'لا تنطبق إطلاقاً' : ''}
                                        ${value === 2 ? 'لا تنطبق إلى حد ما' : ''}
                                        ${value === 3 ? 'تنطبق أحياناً' : ''}
                                        ${value === 4 ? 'تنطبق إلى حد كبير' : ''}
                                        ${value === 5 ? 'تنطبق تماماً' : ''}
                                    </div>
                                </label>
                        `;
                    });
                    questionsHtml += `
                            </div>
                        </div>
                    `;
                });
            }

            appRoot.innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-green-50 to-teal-100 p-6 flex justify-center items-start font-inter">
                    <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-6xl w-full border-4 border-teal-300"> <!-- Increased max-w to 6xl -->
                        <h2 class="text-4xl font-extrabold text-teal-800 mb-8 text-center drop-shadow-md">
                            الاختبار السيكومتري
                        </h2>
                        <form id="test-form" class="space-y-6"> <!-- Adjusted space-y to 6 for consistent spacing -->
                            ${questionsHtml}
                            <div class="text-center mt-10">
                                <button
                                    type="submit"
                                    class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-4 px-12 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-teal-300 text-xl"
                                >
                                    عرض النتائج
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            const testForm = document.getElementById('test-form');
            testForm.addEventListener('change', (e) => {
                if (e.target.type === 'radio' && e.target.name.startsWith('question-')) {
                    const questionIndex = parseInt(e.target.dataset.questionIndex);
                    answers[questionIndex] = parseInt(e.target.value);
                    // Re-render the specific question to update its styling
                    renderView('form'); // This is a simple re-render, for large forms, more granular updates would be needed.
                }
            });

            testForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const totalQuestions = Object.values(questionsData).flat().length;
                if (Object.keys(answers).length !== totalQuestions) {
                    alert('الرجاء الإجابة على جميع الأسئلة قبل المتابعة.');
                    return;
                }

                const calculatedResults = {};
                let questionCounter = 0;
                for (const category in questionsData) {
                    let categoryScore = 0;
                    questionsData[category].forEach(() => {
                        categoryScore += answers[questionCounter];
                        questionCounter++;
                    });
                    calculatedResults[category] = categoryScore;
                }

                const interpretedResults = {};
                for (const category in calculatedResults) {
                    const score = calculatedResults[category];
                    let interpretation = '';
                    if (score >= 6 && score <= 14) {
                        interpretation = 'منخفض';
                    } else if (score >= 15 && score <= 22) {
                        interpretation = 'متوسط';
                    } else if (score >= 23 && score <= 30) {
                        interpretation = 'مرتفع';
                    }
                    interpretedResults[category] = { score, interpretation };
                }

                results = interpretedResults;
                currentView = 'results';
                renderView();
            });
        }

        // Function to render the Results Screen
        function renderResultsScreen() {
            let analysisHtml = '';
            for (const category in results) {
                const data = results[category];
                const analysis = getAnalysisText(category, data.interpretation, data.score);
                analysisHtml += `
                    <div class="bg-white p-5 rounded-xl shadow-md border border-pink-100 text-right print:border print:p-3 print-avoid-break print-mb-3">
                        <h4 class="text-xl font-bold text-pink-800 mb-2 print:text-lg print-report-subheading">
                            ${category} (${data.interpretation})
                        </h4>
                        <p class="text-gray-700 mb-2 print:text-sm print-report-text">
                            <span class="font-semibold">السمات البارزة:</span> ${analysis.text}
                        </p>
                        <p class="text-gray-700 mb-2 print:text-sm print-report-text">
                            <span class="font-semibold">نقاط القوة:</span> ${analysis.strengths}
                        </p>
                        <p class="text-gray-700 mb-2 print:text-sm print-report-text">
                            <span class="font-semibold">مجالات التطوير:</span> ${analysis.development}
                        </p>
                        <p class="text-gray-700 mb-2 print:text-sm print-report-text">
                            <span class="font-semibold">التفاعل مع الآخرين:</span> ${analysis.interaction}
                        </p>
                        <p class="text-gray-700 print:text-sm print-report-text">
                            <span class="font-semibold">مجالات التميز المستقبلية:</span> ${analysis.futureCareers}
                        </p>
                    </div>
                `;
            }

            appRoot.innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-purple-50 to-pink-100 p-6 flex justify-center items-start print:block print:p-0 font-inter">
                    <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-5xl w-full border-4 border-pink-300 print:shadow-none print:border-none print:rounded-none print-container">
                        <h2 class="text-4xl font-extrabold text-purple-800 mb-8 text-center drop-shadow-md print:text-3xl print:mb-4 print-report-heading">
                            تقرير نتائج الاختبار السيكومتري
                        </h2>

                        <!-- Student Info -->
                        <div class="bg-gray-50 p-6 rounded-2xl shadow-inner mb-8 border border-gray-200 print:bg-white print:shadow-none print:border-none print:p-0 print:mb-4 print-avoid-break print-space-y-4">
                            <h3 class="text-2xl font-semibold text-gray-700 mb-4 border-b-2 pb-2 border-gray-300 text-right print:text-xl print:border-b print:pb-1 print-report-heading">
                                معلومات المتدرب
                            </h3>
                            <p class="text-lg text-gray-800 mb-2 text-right print:text-base print-report-text">
                                <span class="font-semibold">الاسم الكامل:</span> ${studentInfo.name}
                            </p>
                            ${studentInfo.traineeCode ? `<p class="text-lg text-gray-800 mb-2 text-right print:text-base print-report-text">
                                <span class="font-semibold">رمز المتدرب:</span> ${studentInfo.traineeCode}
                            </p>` : ''}
                            <p class="text-lg text-gray-800 mb-2 text-right print:text-base print-report-text">
                                <span class="font-semibold">العمر:</span> ${studentInfo.age}
                            </p>
                            <p class="text-lg text-gray-800 mb-2 text-right print:text-base print-report-text">
                                <span class="font-semibold">الجنسية:</span> ${studentInfo.nationality}
                            </p>
                            <p class="text-lg text-gray-800 mb-2 text-right print:text-base print-report-text">
                                <span class="font-semibold">رقم الهاتف:</span> ${studentInfo.phone}
                            </p>
                            <p class="text-lg text-gray-800 mb-2 text-right print:text-base print-report-text">
                                <span class="font-semibold">الوظيفة الحالية:</span> ${studentInfo.currentJob}
                            </p>
                            <p class="text-lg text-gray-800 mb-2 text-right print:text-base print-report-text">
                                <span class="font-semibold">تاريخ الاختبار:</span> ${studentInfo.date}
                            </p>
                            <p class="text-lg text-gray-800 text-right print:text-base print-report-text">
                                <span class="font-semibold">المستوى التعليمي:</span> ${studentInfo.educationalLevel}
                            </p>
                        </div>

                        <!-- Summary of Scores -->
                        <div class="bg-purple-50 p-6 rounded-2xl shadow-inner mb-8 border border-purple-200 print:bg-white print:shadow-none print:border-none print:p-0 print:mb-4 print-avoid-break print-space-y-4">
                            <h3 class="text-2xl font-semibold text-purple-700 mb-4 border-b-2 pb-2 border-purple-300 text-right print:text-xl print:border-b print:pb-1 print-report-heading">
                                ملخص الدرجات
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                ${Object.entries(results).map(([category, data]) => `
                                    <div class="bg-white p-4 rounded-xl shadow-sm border border-purple-100 text-right print:border print:p-2 print-report-text">
                                        <p class="text-lg font-medium text-gray-800 print:text-base">
                                            <span class="font-semibold">${category}:</span> ${data.score} نقطة (${data.interpretation})
                                        </p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Chart Section -->
                        <div class="bg-blue-50 p-6 rounded-2xl shadow-inner mb-8 border border-blue-200 print:bg-white print:shadow-none print:border-none print:p-0 print:mb-4 print-avoid-break print-chart-container">
                            <h3 class="text-2xl font-semibold text-blue-700 mb-4 border-b-2 pb-2 border-blue-300 text-right print:text-xl print:border-b print:pb-1 print-report-heading">
                                تحليل بياني للنتائج
                            </h3>
                            <div class="flex justify-center items-center h-80 w-full">
                                <canvas id="resultsChart" class="w-full h-full print-chart-canvas"></canvas>
                            </div>
                        </div>

                        <!-- Detailed Personality Analysis -->
                        <div class="bg-pink-50 p-6 rounded-2xl shadow-inner mb-8 border border-pink-200 print:bg-white print:shadow-none print:border-none print:p-0 print:mb-4 print-avoid-break print-space-y-4">
                            <h3 class="text-2xl font-semibold text-pink-700 mb-4 border-b-2 pb-2 border-pink-300 text-right print:text-xl print:border-b print:pb-1 print-report-heading">
                                تحليل نمط الشخصية
                            </h3>
                            <div class="space-y-6">
                                ${analysisHtml}
                            </div>
                        </div>

                        <!-- Conclusion -->
                        <div class="bg-gray-50 p-6 rounded-2xl shadow-inner mb-8 border border-gray-200 print:bg-white print:shadow-none print:border-none print:p-0 print:mb-4 print-avoid-break print-space-y-4">
                            <h3 class="text-2xl font-semibold text-gray-700 mb-4 border-b-2 pb-2 border-gray-300 text-right print:text-xl print:border-b print:pb-1 print-report-heading">
                                الخلاصة
                            </h3>
                            <p class="text-lg text-gray-800 leading-relaxed text-right print:text-base print-report-text">
                                نأمل أن يساعد هذا الاختبار المتدربين على اكتشاف ذواتهم بشكل أعمق، وفهم نقاط قوتهم، وتوجيههم
                                نحو مسارات النمو الشخصي والمهني التي تتناسب مع سماتهم الفريدة. إن فهم الشخصية هو الخطوة
                                الأولى نحو تحقيق أقصى إمكانات الفرد في جميع جوانب الحياة.
                            </p>
                        </div>

                        <!-- Print Button (hidden in print mode) -->
                        <div class="text-center mt-10 no-print">
                            <button
                                id="print-report-btn"
                                class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 px-12 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-purple-300 text-xl"
                            >
                                طباعة التقرير
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('print-report-btn').addEventListener('click', () => {
                window.print();
            });

            // Draw the chart after the HTML is rendered
            const chartData = Object.entries(results).map(([category, data]) => ({
                category: category,
                score: data.score,
                interpretation: data.interpretation
            }));
            drawChart('resultsChart', chartData);

            // Redraw chart on window resize to ensure responsiveness
            window.addEventListener('resize', () => {
                drawChart('resultsChart', chartData);
            });
        }

        // Main function to render the current view
        function renderView() {
            appRoot.innerHTML = ''; // Clear previous content
            switch (currentView) {
                case 'intro':
                    renderIntroScreen();
                    break;
                case 'studentInfoModal':
                    renderStudentInfoModal();
                    break;
                case 'form':
                    renderTestForm();
                    break;
                case 'results':
                    renderResultsScreen();
                    break;
                default:
                    renderIntroScreen();
            }
        }

        // Initial render when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', renderView);
    </script>
</body>
</html>
